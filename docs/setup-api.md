[<< Installation & Setup](./setup-main.md)

## API Setup

This section walks you through the process of setting up and running the backend APIs on your local machine, as well as configuring access to cloud-only services like Amazon Polly and OpenAI's Chat Completions API.

1.  First, navigate to the 'api' directory in the cloned repository.

    ```bash
    cd api
    ```

2.  Find the file named '.env.template' in the 'api' folder. This file may be hidden by default in some operating systems due to the dot prefix. To reveal hidden files, follow the instructions for your specific operating system: [Windows](https://support.microsoft.com/en-us/windows/view-hidden-files-and-folders-in-windows-97fbc472-c603-9d90-91d0-1166d1d9f4b5), [macOS](https://www.pcmag.com/how-to/how-to-access-your-macs-hidden-files).

3.  Make a copy of the '.env.template' file to a file named '.api.dev.env'. Be sure to create this copy outside of your repository folder, so you don't accidentally commit your API keys to the public repo.

    For example:

    ```bash
    cp .env.template ~/envs/synth-gpt/.api.dev.env
    ```

4.  Open your '.api.dev.env' file in a text editor.

5.  Create an API key for your local Chat API. This is a manually crafted string, not autogenerated, and should consist of 30-128 alphanumeric characters. Once you've created this key, add it to your '.api.dev.env' file like so:

    ```
    export CHAT_API_KEY=ExampleAPIKey1234abcdeFGHIJKLMnopq
    ```

6.  Sign in to your OpenAI account and generate an API key [here](https://platform.openai.com/account/api-keys). Add the generated key to your '.api.dev.env file.`

    ```
    export OPENAI_API_KEY=Your_OpenAI_API_Key
    ```

7.  Sign in to your AWS console and navigate to IAM. Create a new IAM user and attach the following inline policy:

    ```json
    {
    	"Version": "2012-10-17",
    	"Statement": [
    		{
    			"Effect": "Allow",
    			"Action": "polly:SynthesizeSpeech",
    			"Resource": "*"
    		}
    	]
    }
    ```

    The name of the IAM user is not important, so you can choose any name you like. This user will be used to generate speech with Amazon Polly.

8.  After creating the IAM user, proceed to generate an access key for this user. This action will produce an access key ID and a secret access key. Input these values into your '.api.dev.env' file.

    ```
    export POLLY_ACCESS_KEY_ID=Your_Amazon_Polly_ACCESS_KEY_ID
    export POLLY_SECRET_ACCESS_KEY=Your_Amazon_Polly_SECRET_ACCESS_KEY
    ```

9.  Sign in to your Microsoft Azure portal and navigate to the Bing Search v7 resource. You can follow the instructions [here](https://learn.microsoft.com/en-us/bing/search-apis/bing-web-search/create-bing-search-service-resource) to create a Bing Search resource if you don't already have one.
    Once you have a Bing Search resource, copy one of the generated API keys and add it to your '.api.dev.env' file.

    ```
    export BING_SEARCH_API_KEY=Your_Bing_Search_API_Key
    ```

10. Sign in to your Auth0 account and navigate to your Application. On your Application's 'Settings' tab, locate your 'Domain' and copy it into your '.api.dev.env' file, as shown below:

    ```
    export JWT_ISSUER_DOMAIN=Your_Auth0_Domain
    ```

11. Back in your Auth0 dashboard, navigate to User Management -> Users, and select your newly created user. Scroll down to the 'Identity Provider Attributes' section and copy your 'user_id'. Remove the leading 'auth0|' and copy the remainder of the user_id into your '.api.dev.env' file.

    ```
    export TEST_USER_ID=Your_shortened_user_id
    ```

    This User Id will now be used to seed the 'chat' dynamodb table in development.

12. Save and close the '.api.dev.env' file.

13. Open a bash shell and navigate back to the 'api' folder within the project, then source your env file to set the environment variables

    ```bash
    source ~/envs/synth-gpt/.api.dev.env
    ```

14. Install the npm dependencies

    ```bash
    npm i
    ```

    If there are overrides in the npm dependencies that need to be updated, you may also need to run the npm update command as follows:

    ```bash
    npm update
    ```

15. Finally, run the backend API services

    ```bash
    npm start
    ```

    This command will start the following services:

    - dynamodb-local (port 8000)
    - Rest API endpoints (port 3001)
    - WebSocket endpoints (port 4001)
    - S3-local (port 4569)

Your services and API endpoints should now be up and running.
